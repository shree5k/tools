name: Inject API Variable into HTML

on:
  push:
    branches: [ main ]  # Trigger on push to main; change if needed
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: write  # Explicitly grant write access to repo contents for GITHUB_TOKEN

jobs:
  inject:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # Ensure it checks out the correct branch
        token: ${{ secrets.GITHUB_TOKEN }}  # Use token for full history if needed

    - name: List files in repo (debug)
      run: |
        echo "Current directory structure:"
        find . -type f | head -20  # Lists top 20 files/folders for debugging
        echo "Checking for target file:"
        ls -la testing/ || echo "Directory testing/ not found!"

    - name: Replace placeholder with variable
      env:
        API_ID: ${{ vars.API_ID }}  # Reference variable here (not secrets)
      run: |
        if [ ! -f "testing/index.html" ]; then
          echo "Error: File testing/index.html does not exist!"
          exit 1
        fi
        # Use envsubst for safe variable substitution (handles special chars)
        export API_ID
        envsubst < testing/index.html > testing/index.html.tmp
        mv testing/index.html.tmp testing/index.html
        # Verify the change
        echo "Updated file preview:"
        head -n 20 testing/index.html
        # Debug: Check if placeholder was replaced
        if grep -q '\${API_ID}' testing/index.html; then
          echo "Warning: Placeholder still present!"
        else
          echo "Success: Variable injected (length: ${#API_ID})."
        fi

    - name: Commit and push updated file
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Inject API ID variable into index.html"
        file_pattern: testing/index.html
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}